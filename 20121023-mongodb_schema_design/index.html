<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>MongoDB Schema Design Workshop</title>
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <link rel="stylesheet" href="../vendor/reveal.js/css/reveal.css">
        <link rel="stylesheet" href="../vendor/highlight.js/src/styles/github.css">

        <script>
            // If the query includes 'print-pdf' we'll use the PDF print sheet
            document.write('<link rel="stylesheet" href="../vendor/reveal.js/css/print/' + (window.location.search.match(/print-pdf/gi) ? 'pdf' : 'paper') + '.css" type="text/css" media="print">');
        </script>

        <link rel="stylesheet" href="../common/css/theme.10gen.css">
        <link rel="stylesheet" href="css/main.css">

        <!--[if lt IE 9]>
        <script src="../common/reveal.js/lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>
        <div class="reveal">
            <div class="state-background"></div>

            <div class="slides">
                <section data-state="title">
                    <h1><span class="logo-mongodb">MongoDB</span> Schema Design</h1>

                    <p class="bio">Jeremy Mikola<br><a href="http://twitter.com/jmikola">@jmikola</a></p>
                </section>


                <section>
                    <section data-markdown>
                        # What is a schema?
                    </section>

                    <section data-markdown>
                        ## 3 inputs to Schema Design in mongoDB

                        1. The data your application needs.
                        2. Your application's read usage of the data.
                        3. Your application's write usage of the data.
                    </section>

                </section>

                <section>

                    <section data-markdown>
                        ## Why is schema design important?

                        Schema is defined at the application-level

                        Flexible schema benefits Development phase

                        Good schema needed for production

                        Schema evolves to meet future business needs
                    </section>

                    <section data-markdown>
                        ## MongoDB is a document database

                        Documents are stored in BSON

                        Each document has keys and values
                    </section>

                    <section data-markdown class="ul-2col">
                        ## BSON data types
                        <a href="http://bsonspec.org/">BSONSpec.org</a>

                        * Scalars
                            * Double
                            * UTF-8 String 
                            * Binary
                            * ObjectId
                            * Boolean
                            * UTC DateTime
                            * Null
                            * Regular Expression
                            * 32-bit Integer
                            * Timestamp
                            * 64-bit Integer
                        * Rich types
                            * Documents
                            * Arrays
                    </section>
                </section>
                
                <section>
                
                    <section data-markdown>
                        ## Library web application

                        Different schemas are possible
                    </section>

                    <section data-markdown>
                        ## Author schema
<pre><code class="language-javascript">{
    "_id": int,
    "first_name": string,
    "last_name": string
}</code></pre>
                    </section>

                    <section data-markdown>
                        ## User schema
<pre><code class="language-javascript">{
    "_id": int,
    "username": string,
    "password": string
}</code></pre>
                    </section>


                    <section data-markdown>
                        ## Book schema
<pre><code class="language-javascript">{
    "_id" : int,
    "author" : int,
    "available" : boolean,
    "created_at" : date,
    "created_by" : date,
    "isbn" : string,
    "language" : string,
    "pages" : int,
    "publisher" : {
        "city" : string,
        "name" : string
    },
    "slug" : string,
    "subjects" : [
         string,
         string
   ],
    "title" : string
}</code></pre>

                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## Terminology
                        
                        tables -- collections
                        
                        joins -- embedding and linking
                        
                        rows -- documents
                        
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## Sample documents
                    </section>

                    <section data-markdown>
<pre><code class="language-javascript">db.authors.findOne()
{
    _id: 1,
    first_name: "F. Scott",
    last_name: "Fitzgerald"
}</code></pre>
                    </section>

                    <section data-markdown>
<pre><code class="language-javascript">db.users.findOne()
{
    _id: 1,
    username: "emily@10gen.com",
    password: "slsjfk4odk84k209dlkdj90009283d"
}</code></pre>                        
                    </section> 

                    <section data-markdown>
<pre><code class="language-javascript">db.books.findOne()
{   _id: 1,
    title: "The Great Gatsbyss",
    slug: "9781857150193-the-great-gatsby", 
    author:1,
    available: true,
    isbn: "9781857150193",
    pages: 176,
    publisher: {
        publisher_name: "Everyman’s Library", 
        date: ISODate("1991-09-19T00:00:00Z"), 
        publisher_city: "London"
    },
    subjects: ["Love stories", "1920s", "Jazz Age"], 
    language: "English"    
    reviews: [
       { user: 1, note: "One of the best..."},
       { user: 2, note: "It’s hard to..."} ],

}</code></pre>
                    </section>
               </section>

               <section>
                    <section data-markdown>
                        # Embedded documents
                                                 
                        What advantages do they have?

                        When should they be used?
                    </section>

                    <section data-markdown>
<pre><code class="language-javascript">db.books.findOne()
{   _id: 1,
    title: "The Great Gatsby",
    slug: "9781857150193-the-great-gatsby", 
    author: 1,
    available: true,
    isbn: "9781857150193",
    pages: 176,
    <div class="code-highlight">    publisher: {
        publisher_name: "Everyman’s Library", 
        date: ISODate("1991-09-19T00:00:00Z"), 
        publisher_city: "London"
    },</div>
    subjects: ["Love stories", "1920s", "Jazz Age"],
    language: "English" 
    reviews: [
       { user: 1, note: "One of the best..."},
       { user: 2, note: "It’s hard to..."} ],
}</code></pre> 
                    </section>  
               </section>

               <section>
                    <section data-markdown>
                        # Linked documents
                                                 
                        What advantages does this approach have?

                        When should they be used?
                    </section>

                    <section data-markdown>
<pre><code class="language-javascript">db.books.findOne()
{   _id: 1,
    title: "The Great Gatsby",
    slug: "9781857150193-the-great-gatsby",
    <div class="code-highlight">    author: 1, </div> 
    available: true,
    isbn: "9781857150193",
    pages: 176,
    publisher: {
        publisher_name: "Everyman’s Library", 
        date: ISODate("1991-09-19T00:00:00Z"), 
        publisher_city: "London"
    }, 
    subjects: ["Love stories", "1920s", "Jazz Age"],
    language: "English" 
    reviews: [
       { user: 1, note: "One of the best..."},
       { user: 2, note: "It’s hard to..."} ],
}</code></pre> 
                    </section>

                    <section data-markdown>
                        <img src="img/memory.png">
                    </section>
  
                </section> 

                <section>
                    <section data-markdown>
                        # Arrays
                                                 
                        When should they be used?
                    </section>

                    <section data-markdown>
                        Array of Scalars
<pre><code class="language-javascript">db.books.findOne()
{   _id: 1,
    title: "The Great Gatsby",
    slug: "9781857150193-the-great-gatsby",
    author: 1, 
    available: true,
    isbn: "9781857150193",
    pages: 176,
    publisher: {
        publisher_name: "Everyman’s Library", 
        date: ISODate("1991-09-19T00:00:00Z"), 
        publisher_city: "London"
    }, 
    <div class="code-highlight">    subjects: ["Love stories", "1920s", "Jazz Age"], </div> 
    language: "English"
    reviews: [
       { user: 1, note: "One of the best..."},
       { user: 2, note: "It’s hard to..."} ],
}</code></pre>
                     </section>

                    <section data-markdown>
                        Array of documents
<pre><code class="language-javascript">db.books.findOne()
{   _id: 1,
    title: "The Great Gatsby",
    slug: "9781857150193-the-great-gatsby",
    author: 1, 
    available: true,
    isbn: "9781857150193",
    pages: 176,
    publisher: {
        publisher_name: "Everyman’s Library", 
        date: ISODate("1991-09-19T00:00:00Z"), 
        publisher_city: "London"
    }, 
    subjects: ["Love stories", "1920s", "Jazz Age"], 
    language: "English"
    <div class="code-highlight">    reviews: [
       { user: 1, note: "One of the best..."},
       { user: 2, note: "It’s hard to..."} ], 
    </div>
}</code></pre>
                     </section>
 
                </section>  

                <section> 
                    <section data-markdown>
                        # Development Phase 
                        Basic CRUD functions
                    </section>
                 </section>

                 <section>
                    <section data-markdown>
                        # Create
<pre><code class="language-javascript">
    author = {  _id: 2,
               first_name: "Arthur",
               last_name: "Miller"
    }

    db.authors.insert(author)

</code></pre>
                        *  <a href="http://www.mongodb.org/display/DOCS/Object+IDs#ObjectIDs-BSONObjectIDSpecification">_id</a> is unique and automatically indexed
                        * An ObjectId will be generated by mongoDB if not provided
                    </section>
                 </section>
                 <section>
                    <section data-markdown>
                        # Read
<pre><code class="language-javascript">
    db.authors.find({ "last_name": "Miller" })

    {  _id: 2,
       first_name: "Arthur",
       last_name: "Miller"
    }

</code></pre>
                    </section>
                    <section data-markdown>
                        ## Add an Index
<pre><code class="language-javascript">
    db.authors.ensureIndex({ "last_name": 1 })
</code></pre>
                        ## Examine the query
<pre><code class="language-javascript">
db.authors.find({ "last_name": "Miller" }).explain()
{<div class="code-highlight">    "cursor": "BtreeCursor slug_1",</div>    "isMultiKey" : false,
    "n" : 1,
    "nscannedObjects" : 1,
    "nscanned" : 1,
    "scanAndOrder" : false,
    "indexOnly" : false,
    "nYields" : 0,
    "nChunkSkips" : 0,
    "millis" : 0,
.....
}
</code></pre>
                    </section>

                     <section data-markdown>
                         ## Multi-key indexes on arrays

<pre><code class="language-javascript">
     db.books.ensureIndex({ "subjects": 1 })

</code></pre>
                     </section>

                    <section data-markdown>
                         ## Indexes on embedded document keys

<pre><code class="language-javascript">
     db.books.ensureIndex({ "publisher.name": 1 })

</code></pre>
                     </section>
 
                    <section data-markdown>
                        ## Query operators

                        * Conditional operators
                            * <code>$all, $exists, $mod, $ne, $nin, $nor, $or, $and, $size, $type</code>
                        * Regular Expressions
                        * Value in an array
                            * <code>$elemMatch</code>
                        * Cursor methods
                            * <code>count(), limit(), skip(), snapshot(), sort(), batchSize()</code>
                    </section>
                 </section>

                 <section>
                    <section data-markdown>
                        # Update 
<pre><code class="language-javascript">
     review = { user: 1, note: "I did NOT like this book." }
     db.books.update({ _id: 1 }, {$push: {reviews: review }})

</code></pre>
                    </section>
                    <section data-markdown class="ul-2col">
                        ## Take advantage of atomic operations
                        * $set
                        * $unset
                        * $inc
                        * $push
                        * $pushAll
                        * $pull
                        * $pullAll
                        * $bit
                    </section>

                </section>

                <section>
                    <section data-markdown>
                        # Remove
<pre><code class="language-javascript">
     db.books.remove({ _id: 1 })

</code></pre>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        # Production Phase
                        Evolve schema to meet data usage needs
                    </section>

                    <section data-markdown>
                        ## Heavy reads
<pre><code class="language-javascript">
     authors = db.authors.find( { first_name: /^f.*/i }, {_id: 1})
     authorIds = authors.map(function(x) { return x._id; })
     db.books.find({author: { $in: authorIds } })

</code></pre>
                        * What are the query patterns?
                    </section>
                    <section data-markdown>
                        ## Heavy writes
<pre><code class="language-javascript">
     review = { user: 1, "One of the best..." }
     db.books.update({ _id: 3 }, {$push: {reviews: review }})

</code></pre>
                        * 16mb document size limit
                        * Possible Storage fragmentation with many updates
                    </section>

                </section>

                <section>
                    <section data-markdown>
                        # I Like Turtles
                    </section>
                </section>


                <section>
                    <section data-markdown class="ul-2col">
                        ## Exercise #1

                        Design a schema for user reviews for books.

                        * Users
                            * name (string)
                            * email (string)
                        * Reviews
                            * text (string)
                            * rating (integer)
                    </section>

                    <section data-markdown class="ul-2col">
                        ## Exercise #1: Solution A

                        <pre><code class="language-javascript">// db.users (one document per user)
{
  _id: ObjectId("…"),
  username: "bob",
  email: "bob@example.com"
}</code></pre>

                        <pre><code class="language-javascript">// db.reviews (one document per review)
{
  _id: ObjectId("…"),
  user: ObjectId("…"),
  book: ObjectId("…"),
  text: "This book is excellent!",
  rating: 5,
  created_at: ISODate("2012-10-10T21:14:07.096Z")
}</code></pre>
                    </section>

                    <section data-markdown class="ul-2col">
                        ## Exercise #1: Solution B

                        <pre><code class="language-javascript">// db.users (one document per user with all reviews)
{
  _id: ObjectId("…"),
  username: "bob",
  email: "bob@example.com",
  reviews: [
    {
      book: ObjectId("…"),
      text: "This book is excellent!",
      rating: 5,
      created_at: ISODate("2012-10-10T21:14:07.096Z")
    }
  ]
}</code></pre>
                    </section>

                    <section data-markdown class="ul-2col">
                        ## Exercise #1: Solution C

                        <pre><code class="language-javascript">// db.users (one document per user)
{
  _id: ObjectId("…"),
  username: "bob",
  email: "bob@example.com"
}</code></pre>

                        <pre><code class="language-javascript">// db.books (one document per book with all reviews)
{
  _id: ObjectId("…"),
  // Other book fields
  reviews: [
    {
      user: ObjectId("…"),
      text: "This book is excellent!",
      rating: 5,
      created_at: ISODate("2012-10-10T21:14:07.096Z")
    }
  ]
}</code></pre>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ### Exercise #2: Alternative Schema

                        Display last 10 book reviews from today.

                        Efficiently use memory and disk seeks.
                    </section>
                </section>
            </div>

            <div class="footer"></div>
        </div>

        <script src="../vendor/reveal.js/lib/js/head.min.js"></script>
        <script src="../vendor/reveal.js/js/reveal.js"></script>
        <script src="../common/js/reveal.js"></script>
    </body>
</html>
