<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Getting Acquainted with MongoDB</title>
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <link rel="stylesheet" href="../vendor/reveal.js/css/reveal.css">
        <link rel="stylesheet" href="../vendor/highlight.js/src/styles/tomorrow-night-eighties.css">
        <link rel="stylesheet" href="../vendor/reveal.js/css/theme/default.css">
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="../vendor/reveal.js/css/print/pdf.css" type="text/css" media="print">

        <!--[if lt IE 9]>
        <script src="../vendor/reveal.js/lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>
        <div class="reveal">
            <div class="slides">
                <section data-state="title">
                    <h1>Getting Acquainted with <span class="mongodb-logo">MongoDB</span></h1>

                    <p class="bio">Jeremy Mikola<br><a href="http://twitter.com/jmikola">@jmikola</a></p>
                </section>

                <section data-markdown data-state="about-10gen">
                    ## 10gen

                    * Develops MongoDB
                    * Provides support, training, and consulting
                    * Loves the community
                        * Mailing lists, IRC, and Stack Overflow
                        * Sponsors conferences and user groups
                    * Offices: NYC, Palo Alto, Europe, Australia
                    * Hiring at [10gen.com/careers](http://10gen.com/careers)
                </section>

                <section data-markdown data-state="starting-off">
                    ## Starting Off

                    <ul>
                        <li>What sets MongoDB apart?</li>
                        <li class="fragment">What are documents?</li>
                        <li class="fragment">What can we do with them?</li>
                        <li class="fragment">How can we do that faster?</li>
                        <li class="fragment">What else can we do?</li>
                    </ul>
                </section>

                <section>
                    <section data-markdown data-state="terminology">
                        # Terminology

<pre><code class="language-javascript">{
    "mongodb"    : "relational db",
    "database"   : "database",
    "collection" : "table",
    "document"   : "row",
    "index"      : "index",
    "_id"        : "primary key",
    "sharding" : {
        "shard"     : "partition",
        "shard key" : "partition key"
    }
}</code></pre>
                    </section>

                    <section data-markdown>
                        ## RDBMS: The Good Parts

                        * Tried and true
                        * SQL is a rich query language
                        * ACID compliance
                        * Transactions
                    </section>

                    <section data-markdown>
                        ## RDBMS: The Bad Parts

                        * Modeling complex or polymorphic data
                        * Schema migrations
                        * Administration
                        * Scalability is a trade-off
                    </section>

                    <section data-markdown>
                        ## MongoDB: The Good Parts

                        * Document model
                        * Flexible schemas
                        * Scalability and performance
                        * Features (aggregation, geo, GridFS)
                    </section>

                    <section data-markdown>
                        ## MongoDB: The Bad Parts

                        * Limited atomicity
                        * Consistency is a trade-off
                        * Query language limitations
                        * Concurrency (improving)
                    </section>

                    <section data-state="database-landscape">
                        <h2>Database Landscape</h2>

                        <div class="diagram">
                            <ul>
                                <li class="memcached">Memcached</li>
                                <li class="key-value">Key/Value</li>
                                <li class="mongodb">MongoDB</li>
                                <li class="rdbms">RDBMS</li>
                            </ul>
                            <div class="y-axis">Scalability and Performance</div>
                            <div class="x-axis">Depth of Functionality</div>
                        </div>
                    </section>

                    <section data-markdown>
                        # Why MongoDB?

                        <blockquote>
                            MongoDB has the best features of key/value stores, document databases and relational databases in one.<br>&mdash; <a href="http://twitter.com/jnunemaker">John Nunemaker</a>
                        </blockquote>
                    </section>
                </section>

                <section>
                    <section data-markdown data-state="relational-modeling">
                        ## Relational Modeling

                        * Articles
                            * One author
                            * Many comments
                            * Many tags
                        * Authors
                            * Many articles
                            * Many comments
                        * Tags
                            * Many articles
                        * Comments
                            * One article
                            * One author
                    </section>

                    <section data-state="relational-diagram">
                        <h2>Relational Modeling</h2>

                        <table class="bordered" id="relational-articles">
                            <thead>
                                <tr><th colspan="4">articles</th></tr>
                                <tr>
                                    <th>id</th>
                                    <th>author_id</th>
                                    <th>title</th>
                                    <th>body</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>1</td>
                                    <td>2</td>
                                    <td>Praesent ante dui</td>
                                    <td>Lorem ipsum…</td>
                                </tr>
                            </tbody>
                        </table>

                        <table class="bordered" id="relational-articles-to-tags">
                            <thead>
                                <tr><th colspan="3">articles_to_tags</th></tr>
                                <tr>
                                    <th>id</th>
                                    <th>article_id</th>
                                    <th>tag_id</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>36</td>
                                    <td>1</td>
                                    <td>7</td>
                                </tr>
                                <tr>
                                    <td>37</td>
                                    <td>1</td>
                                    <td>8</td>
                                </tr>
                            </tbody>
                        </table>

                        <table class="bordered" id="relational-authors">
                            <thead>
                                <tr><th colspan="3">authors</th></tr>
                                <tr>
                                    <th>id</th>
                                    <th>name</th>
                                    <th>email</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2</td>
                                    <td>Bob</td>
                                    <td>bob@example.com</td>
                                </tr>
                                <tr>
                                    <td>3</td>
                                    <td>John</td>
                                    <td>john@example.com</td>
                                </tr>
                            </tbody>
                        </table>

                        <table class="bordered" id="relational-comments">
                            <thead>
                                <tr><th colspan="4">comments</th></tr>
                                <tr>
                                    <th>id</th>
                                    <th>article_id</th>
                                    <th>author_id</th>
                                    <th>body</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>4</td>
                                    <td>1</td>
                                    <td>3</td>
                                    <td>Morbi libero erat…</td>
                                </tr>
                                <tr>
                                    <td>5</td>
                                    <td>1</td>
                                    <td>2</td>
                                    <td>Dapibus quis…</td>
                                </tr>
                                <tr>
                                    <td>6</td>
                                    <td>1</td>
                                    <td>3</td>
                                    <td>Fusce fermentum…</td>
                                </tr>
                            </tbody>
                        </table>

                        <table class="bordered" id="relational-tags">
                            <thead>
                                <tr><th colspan="2">tags</th></tr>
                                <tr>
                                    <th>id</th>
                                    <th>name</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>7</td>
                                    <td>luctus</td>
                                </tr>
                                <tr>
                                    <td>8</td>
                                    <td>rhoncus</td>
                                </tr>
                            </tbody>
                        </table>
                    </section>

                    <section data-markdown data-state="relational-segue">
                        # Things May Get Out of Hand
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## Document Modeling

                        * Articles
                            * One author
                            * Many comments
                                * One author
                            * Many tags
                    </section>

                    <section data-markdown>
                        ## Document Modeling

<pre><code class="language-javascript">{
    _id: 1,
    title: "Praesent ante dui",
    body: "Lorem ipsum…",
    author: { name: "Bob", email: "bob@example.com" },
    comments: [
        {
            body: "Morbi libero erat…",
            author: { name: "John", email: "john@example.com" }
        },
        {
            body: "Dapibus quis…",
            author: { name: "Tom", email: "tom@example.com" }
        },
    ],
    tags: [ "luctus", "rhoncus" ]
}</code></pre>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## Documents are BSON

                        * [Binary JSON](http://bsonspec.org/)
                        * Zero or more key/value pairs
                        * Values are scalars, arrays, and objects
                        * Special types (e.g. binary strings, dates)
                    </section>

                    <section data-markdown>
                        ## Documents in PHP

<pre><code class="language-php">// Arrays are most common
$a = ['hello' => 'world'];

$b = ['things' => ['foo', 5.05, 2012]];</code></pre>

<pre><code class="language-php">// Objects work, too!
$a = new stdClass();
$a->hello = 'world';

$b = new stdClass();
$b->things = ['foo', 5.05, 2012];</code></pre>

                    </section>
                </section>

                <section>
                    <section data-state="getting-started">
                        <h1>Getting Up and Running with Mongo</h1>

                        <h3 class="fragment">In 60 Seconds</h3>

                        <h6 class="fragment">* Excluding download time :)</h6>
                    </section>

                    <section data-markdown>
                        ## [mongodb.org/downloads](http://www.mongodb.org/downloads)

                        * Compiled binaries
                            * OS X, Linux, Windows, Solaris
                        * Packages
                            * MacPorts, Homebrew, Debian, CentOS
                        * Drivers for over a dozen languages
                    </section>

                    <section data-markdown>
                        ## Installing

<pre><code class="no-highlight">$ tar xvzf mongodb-linux-x86_64-2.2.3.tgz
mongodb-linux-x86_64-2.2.3/GNU-AGPL-3.0
mongodb-linux-x86_64-2.2.3/README
mongodb-linux-x86_64-2.2.3/THIRD-PARTY-NOTICES
mongodb-linux-x86_64-2.2.3/bin/mongodump
mongodb-linux-x86_64-2.2.3/bin/mongorestore
mongodb-linux-x86_64-2.2.3/bin/mongoexport
mongodb-linux-x86_64-2.2.3/bin/mongoimport
mongodb-linux-x86_64-2.2.3/bin/mongostat
mongodb-linux-x86_64-2.2.3/bin/mongotop
mongodb-linux-x86_64-2.2.3/bin/mongooplog
mongodb-linux-x86_64-2.2.3/bin/mongofiles
mongodb-linux-x86_64-2.2.3/bin/bsondump
mongodb-linux-x86_64-2.2.3/bin/mongoperf
mongodb-linux-x86_64-2.2.3/bin/mongosniff
mongodb-linux-x86_64-2.2.3/bin/mongod
mongodb-linux-x86_64-2.2.3/bin/mongos
mongodb-linux-x86_64-2.2.3/bin/mongo</code></pre>
                    </section>

                    <section data-markdown>
                        ## Starting

<pre><code class="no-highlight" style="overflow: hidden; word-wrap: normal;">$ mkdir /data/db

$ mongodb-linux-x86_64-2.2.3/bin/mongod
[initandlisten] MongoDB starting : pid=13917 port=27017 dbpath=/data/db/ 64-bit host=honeydew
[initandlisten] db version v2.2.3, pdfile version 4.5
[initandlisten] git version: f570771a5d8a3846eb7586eaffcf4c2f4a96bf08
[initandlisten] build info: Linux ip-10-2-29-40 2.6.21.7-2.ec2.v1.2.fc8xen #1 SMP Fri Nov 20 17:48:28 EST 2009 x86_64 BOOST_LIB_VERSION=1_49
[initandlisten] options: {}
[initandlisten] journal dir=/data/db/journal
[initandlisten] recover : no journal files present, no recovery needed
[initandlisten] waiting for connections on port 27017
[websvr] admin web console waiting for connections on port 28017</code></pre>
                    </section>

                    <section data-markdown>
                        ## Connecting

<pre><code class="no-highlight">$ mongo
MongoDB shell version: 2.2.3
connecting to: test

> show dbs
local   (empty)

> db.foo.insert({x: 1})

> db.foo.find()
{ "_id" : ObjectId("50368f0cdea8fae83cf3d097"), "x" : 1 }</code></pre>
                    </section>

                    <section data-markdown data-state="php-driver">
                        ## PHP Driver

                        * [PECL extension](http://pecl.php.net/package/mongo)
                        * Classes for Mongo resources, types
                        * BSON encode/decode functions
                        * Persistent connections, logging
                        * [INI configuration](http://us3.php.net/manual/en/mongo.configuration.php)
                        * Track development on [GitHub](https://github.com/mongodb/mongo-php-driver) and [JIRA](https://jira.mongodb.org/browse/PHP)

                        <blockquote class="fragment">
                            The single, best interface of any PHP extension &mdash; <a href="http://twitter.com/mwop">Matthew Weier O'Phinney</a>
                        </blockquote>
                    </section>

                    <section data-markdown>
                        ## PHP Driver Installation

<pre><code class="no-highlight">$ pecl install mongo
downloading mongo-1.3.4.tgz ...
Starting to download mongo-1.3.4.tgz (124,844 bytes)
............................done: 124,844 bytes
49 source files, building

...

Build process completed successfully
Installing '/usr/lib/php5/20100525/mongo.so'
install ok: channel://pecl.php.net/mongo-1.3.4</code></pre>

                        <ul class="fragment">
                            <li><a href="http://php.net/manual/en/mongo.installation.php">Compiled binaries</a> for Windows</li>
                            <li>Included with Zend Server</li>
                        </ul>
                    </section>
                </section>

                <section>
                    <section data-markdown data-state="get-cooking">
                        # Let's Get Cooking
                    </section>

                    <section data-markdown>
                        ## Core Classes

                        * [MongoClient](http://php.net/manual/en/class.mongoclient.php)
                        * [MongoDB](http://php.net/manual/en/class.mongodb.php)
                        * [MongoCollection](http://php.net/manual/en/class.mongocollection.php)
                        * [MongoCursor](http://php.net/manual/en/class.mongocursor.php)
                    </section>

                    <section data-markdown data-state="driver-type-classes">
                        ## Type Classes

                        * [MongoId](http://php.net/manual/en/class.mongoid.php)
                        * [MongoCode](http://php.net/manual/en/class.mongocode.php)
                        * [MongoDate](http://php.net/manual/en/class.mongodate.php)
                        * [MongoRegex](http://php.net/manual/en/class.mongoregex.php)
                        * [MongoBinData](http://php.net/manual/en/class.mongobindata.php)
                        * [MongoInt32](http://php.net/manual/en/class.mongoint32.php)
                        * [MongoInt64](http://php.net/manual/en/class.mongoint64.php)
                        * [MongoMinKey](http://php.net/manual/en/class.mongominkey.php)
                        * [MongoMaxKey](http://php.net/manual/en/class.mongomaxkey.php)
                        * [MongoTimestamp](http://php.net/manual/en/class.mongotimestamp.php)
                    </section>

                    <section data-markdown>
                        ## Connecting

<pre><code class="language-php">// localhost:27017
$m = new MongoClient();

<span class="fragment">// example.com:27018
$m = new MongoClient('mongodb://example.com:27018');</span>

<span class="fragment">// authentication
$m = new MongoClient('mongodb://user:password@localhost');</span>

<span class="fragment">// replica set
$m = new MongoClient(
    'mongodb://rs1.example.com,rs2.example.com',
    ['replicaSet' => 'myReplSet']
);</span></code></pre>
                    </section>

                    <section data-markdown>
                        ## The MongoClient Class

<pre><code class="language-php">$m = new MongoClient();

<span class="fragment">// Get a MongoDB for the "test" database
$m->test;
$m->selectDB('test');</span>

<span class="fragment">// Get a MongoCollection for "test.users"
$m->test->users;
$m->selectCollection('test', 'users');</span>

<span class="fragment">// Drop the "test" database
$m->dropDB('test');</span></code></pre>
                    </section>

                    <section data-markdown>
                        ## The MongoDB Class

<pre><code class="language-php">$db = $m->test;
$db = new MongoDB($m, 'test');

<span class="fragment">// Get a MongoCollection for "test.users"
$db->users;
$db->selectCollection('users');</span>

<span class="fragment">// Create a capped collection limited to 10KiB and 10 documents
$db->createCollection('logs', true, 10240, 10)</span>

<span class="fragment">$db->dropCollection('users'); // Drop "test.users"
$db->drop();                  // Drop the entire database</span></code></pre>
                    </section>

                    <section data-markdown>
                        ## The MongoCollection Class

<pre><code class="language-php">$c = $db->users;
$c = new MongoCollection($db, 'users');

<span class="fragment">// Insert a user document for Bob
$c->insert(['username' => 'bob', 'roles' => ['admin']]);</span>

<span class="fragment">// Retrieve Bob's user document
$c->findOne(['username' => 'bob']);</span>

<span class="fragment">// Find all admins (returns a MongoCursor)
$c->find(['roles' => 'admin']);</span></code></pre>
                    </section>

                    <section data-markdown>
                        ## The MongoCollection Class

<pre><code class="language-php">$c->count();                     // Count all users
$c->count(['roles' => 'admin']); // Count only admins

<span class="fragment">$c->remove(['username' => 'john']); // Delete a user
$c->remove();                       // Delete all users</span>

<span class="fragment">// Drop the entire collection
$c->drop();</span></code></pre>
                    </section>
                </section>

                <section>
                    <section data-markdown data-state="identifiers">
                        ## Identifiers

                        <blockquote>
                            You have the right to an <code>_id</code>.<br>
                            It must be unique to a collection.<br>
                            If no <code>_id</code> is provided, the driver<br>
                            will generate one for you.
                        </blockquote>
                    </section>

                    <section data-markdown>
                        ## Identifiers

<pre><code class="language-php">// Create a user document for Tom
$user = ['username' => 'tom'];

<span class="fragment">// Insert Tom's document
$c->insert($user);</span>

<span class="fragment">var_dump($user);
<span class="stdout">array(2) {
  ["username"]=>
  string(3) "tom"
  ["_id"]=>
  object(MongoId)#3 (1) {
    ["$id"]=>
    string(24) "503b0772e84df1f87b000001"
  }
}</span></span></code></pre>
                    </section>

                    <section data-markdown>
                        ## The `_id` Field

                        * Immutable
                        * Unique to the collection
                        * ObjectId, scalar, or object
                        * Indexed by default

                    </section>

                    <section data-markdown>
                        ## BSON ObjectId

                        <table class="bordered">
                            <tr>
                                <td><code>5033ea5c</code></td>
                                <td><code>e84df1</code></td>
                                <td><code>110f</code></td>
                                <td><code>000001</code></td>
                            </tr>
                            <tr>
                                <td>Timestamp</td>
                                <td>Hostname</td>
                                <td>PID</td>
                                <td>Sequence</td>
                            </tr>
                        </table>

                        * 12-byte, binary string
                        * Easily generated in cluster environments
                        * Timestamp prefix useful for sorting
                    </section>

                    <section data-markdown>
                        ## The MongoId Class

<pre><code class="language-php">$id = new MongoId();

echo (string) $id;        // 5033ea5ce84df1110f000001
echo $id->getTimestamp(); // 1345579612
echo $id->getHostname();  // honeydew (before hashing)
echo $id->getPID();       // 3857
echo $id->getInc();       // 1

<span class="fragment">// Strings will not match an ObjectId
$c->find(['_id' => '5033ea5ce84df1110f000001']);

// Use MongoId in query criteria
$c->find(['_id' => new MongoId('5033ea5ce84df1110f000001']));</span></code></pre>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## Writing to MongoDB

                        * Inserts, updates, and upserts
                        * Consistency/performance options
                        * Don't shoot yourself in the foot
                    </section>

                    <section data-markdown>
                        ## Write Concern

                        * `{w: 0}`
                            * Fire and forget
                            * Trade consistency for performance
                        * `{w: 1}`
                            * Ensure primary acknowledges write
                            * Issues [getLastError](http://docs.mongodb.org/manual/reference/command/getLastError/) command
                        * `{w: #}` or `{w: "majority"}`
                            * Wait for multiple acknowledgements
                    </section>

                    <section data-markdown>
                        ## Inserting

<pre><code class="language-php">$c = $db->users;

$user = $c->findOne(['username' => 'tom']);

<span class="fragment">$c->insert($user, ['w' => 1]); // MongoClient's default behavior
<span class="stdout">Uncaught exception: MongoCursorException:
  E11000 duplicate key error index: test.users.$_id_
  dup key: { : ObjectId('503b0772e84df1f87b000001') }</span></span>

<span class="fragment">$c->insert($user, ['w' => 0]); // No error, but nothing inserted</span>

<span class="fragment">$db->lastError(); // Manually call getLastError
<span class="stdout">array(
  "err" => "E11000 duplicate key error…",
  "code" => 11000,
  "n" => 0,
  "connectionId" => 16,
  "ok" => 1,
)</span></span></code></pre>
                    </section>

                    <section data-markdown>
                        ## Saving

<pre><code class="language-php">// Modify Tom's user
$user = $c->findOne(['username' => 'tom']);
$user['email'] = 'tom@example.com';
$user['roles'][] = 'moderator';
$c->save($user);</code></pre>

                        * Is there an `_id`?
                            * Yes, upsert the document
                            * No, insert the document
                        * Race conditions when updating
                    </section>

                    <section data-markdown>
                        ## Updating a Document

<pre><code class="language-php">// Change Tom's email address
$c->update(
    ['username' => 'tom'],
    ['$set' => ['email' => 'thomas@example.com']]
);</code></pre>

                        * Criteria
                        * New object
                            * Overwrite entire document
                            * Apply atomic operations
                    </section>

                    <section data-markdown>
                        ## Updating Multiple Documents

<pre><code class="language-php">// Make everyone an admin (probably a bad idea :)
$c->update(
    [],
    ['$addToSet' => ['roles' => 'admin']],
    ['multiple' => true]
);</code></pre>
                    </section>

                    <section data-markdown>
                        ## Upserting

<pre><code class="language-php">// Ensure Sam exists as staff
$c->update(
    ['username' => 'sam'],
    ['$set' => ['role' => 'staff']],
    ['upsert' => true]
);</code></pre>

                        * No multi-document operation
                        * Does the criteria match a document?
                            * Yes, update the document
                            * No, insert the document
                        * [Insert applies modifiers to criteria](http://docs.mongodb.org/manual/applications/update/#update-operations-with-the-upsert-flag)
                    </section>

                    <section data-markdown data-state="atomic-operators">
                        ## Atomic Operators

                        * Numbers
                            * [$inc](http://docs.mongodb.org/manual/reference/operator/inc/)
                        * Integers
                            * [$bit](http://docs.mongodb.org/manual/reference/operator/bit/)
                        * Anything
                            * [$set](http://docs.mongodb.org/manual/reference/operator/set/)
                            * [$unset](http://docs.mongodb.org/manual/reference/operator/unset/)
                            * [$rename](http://docs.mongodb.org/manual/reference/operator/rename/)
                        * Arrays
                            * [$addToSet](http://docs.mongodb.org/manual/reference/operator/addToSet/)
                            * [$pop](http://docs.mongodb.org/manual/reference/operator/pop/)
                            * [$push](http://docs.mongodb.org/manual/reference/operator/push/), [$pushAll](http://docs.mongodb.org/manual/reference/operator/pushAll/)
                            * [$pull](http://docs.mongodb.org/manual/reference/operator/pull/), [$pullAll](http://docs.mongodb.org/manual/reference/operator/pullAll/)
                    </section>

                    <section data-markdown>
                        ## [Positional Updates](http://docs.mongodb.org/manual/reference/operator/positional/)

<pre><code class="language-php">// An article with votable comments
$db->articles->insert([
    '_id' => 1,
    'title' => 'Praesent ante dui',
    'comments' => [
        ['body' => 'Dapibus quis…', 'votes' => 2],
        ['body' => 'Fusce fermentum…', 'votes' => 0],
    ],
]);

<span class="fragment">// Upvote the second comment
$db->articles->update(
    ['comments.body' => 'Fusce fermentum…'],
    ['$inc' => ['comments.$.votes' => 1]]
);</span></code></pre>
                    </section>
                </section>

                <section>
                    <section data-markdown data-state="querying">
                        # Queries
                    </section>

                    <section data-markdown>
                        ## Basic Querying

<pre><code class="language-php">$c->findOne(); // Retrieve one document as an array
$c->find();    // Find all documents via MongoCursor

// Query on field values
$c->findOne(['lastName' => 'Smith']);
$c->find(['roles' => 'admin']);</code></pre>

                        * Query criteria is BSON
                        * No grammar to parse
                    </section>

                    <section data-markdown>
                        ## Queries Return Cursors

                        * Cursors navigate a query result
                        * Pre-query state
                            * No database contact yet
                            * `limit()`, `skip()`, `sort()`
                            * Set [special flags](http://docs.mongodb.org/manual/reference/meta-query-operators/)
                        * Post-query state
                            * Iteration has begun
                            * Cannot be modified
                    </section>

                    <section data-markdown>
                        ## The MongoCursor Class

<pre><code class="language-php">$cursor = $db->users->find();      // Find all users
$cursor->sort(['username' => -1]); // Desc sort by username
$cursor->limit(10);                // Limit to 10 results
$cursor->skip(5);                  // Skip the first 5

<span class="fragment">// Iterate through results
foreach ($cursor as $result) { }

// Get them all at once
$results = iterator_to_array($cursor);</span>

<span class="fragment">$cursor->count();     // Count irrespective of limit/skip
$cursor->count(true); // Count with respect to limit/skip</span></code></pre>
                    </section>

                    <section data-markdown data-state="business-requirements">
                        ## Ad-hoc Querying

                        <blockquote>
                            <small>Arbitrary Business Requirement #42789!</small><br>
                            We need the usernames for all admins that use Gmail and whose accounts were created within the last year.
                        </blockquote>
                    </section>

                    <section data-markdown>
                        ## Data to Query

<pre><code class="language-php">$c = $db->users;

$c->save([
    'username' => 'bob',
    'email' => 'bob@example.com',
    'profile' => [
        'bio' => "I am a data fixture.",
        'createdAt' => new MongoDate(),
    ],
    'roles' => ['moderator', 'admin'],
]);

// Among others…</code></pre>
                    </section>

                    <section data-markdown>
                        ## Complex Criteria

<pre><code class="language-php">$lastYear = strtotime('last year');

// Arbitrary Business Requirement #42789!
$db->users->find([
    'email' => new MongoRegex('/gmail\.com$/i');
    'profile.createdAt' => [
        '$gt' => new MongoDate($lastYear)
    ],
    'roles' => 'admin',
]);</code></pre>

                        * [Regular expressions](http://docs.mongodb.org/manual/reference/operator/regex/)
                        * [Matching values in embedded objects](http://docs.mongodb.org/manual/reference/glossary/#term-dot-notation)
                        * [Conditional operators](http://docs.mongodb.org/manual/reference/operators/#logical)
                        * [Matching a value in an array](http://docs.mongodb.org/manual/core/read-operations/#arrays)
                    </section>

                    <section data-markdown>
                        ## Field Projection

<pre><code class="language-php">// Optimize by only selecting usernames
$db->users->find([
    'email' => new MongoRegex('/gmail\.com$/i');
    'profile.createdAt' => [
        '$gt' => new MongoDate($lastYear)
    ],
    'roles' => 'admin',
], ['_id' => 0, 'username' => 1]);</code></pre>

                        * [Retrieving a subset of fields](http://docs.mongodb.org/manual/core/read-operations/#projection)
                        * [Retrieving a slice of an array](http://docs.mongodb.org/manual/reference/projection/slice/)
                    </section>

                    <section data-markdown data-state="query-operators">
                        ## Conditional Operators

                        * Comparison
                            * [$gt](http://docs.mongodb.org/manual/reference/operator/gt/), [$gte](http://docs.mongodb.org/manual/reference/operator/gte/)
                            * [$lt](http://docs.mongodb.org/manual/reference/operator/lt/), [$lte](http://docs.mongodb.org/manual/reference/operator/lte/)
                            * [$ne](http://docs.mongodb.org/manual/reference/operator/ne/)
                        * Logical
                            * [$and](http://docs.mongodb.org/manual/reference/operator/and/)
                            * [$or](http://docs.mongodb.org/manual/reference/operator/or/), [$nor](http://docs.mongodb.org/manual/reference/operator/nor/)
                        * Arrays
                            * [$all](http://docs.mongodb.org/manual/reference/operator/all/)
                            * [$in](http://docs.mongodb.org/manual/reference/operator/in/), [$nin](http://docs.mongodb.org/manual/reference/operator/nin/)
                            * [$size](http://docs.mongodb.org/manual/reference/operator/size/)
                            * [$elemMatch](http://docs.mongodb.org/manual/reference/operator/elemMatch/)
                        * Misc
                            * [$exists](http://docs.mongodb.org/manual/reference/operator/exists/)
                            * [$type](http://docs.mongodb.org/manual/reference/operator/type/)
                        * Numbers
                            * [$mod](http://docs.mongodb.org/manual/reference/operator/mod/)
                        * Meta
                            * [$not](http://docs.mongodb.org/manual/reference/operator/not/)
                            * [$where](http://docs.mongodb.org/manual/reference/operator/where/)
                    </section>
                </section>

                <section>
                    <section data-markdown data-state="findandmodify">
                        # A Pickle

                        * We can query for things
                        * We can update documents atomically
                        * Can we combine queries and updates?
                    </section>

                    <section data-markdown>
                        ## Data to Process

<pre><code class="language-php">$c = $db->jobs;

$c->save([
    'task' => '…',
    'inprogress' => 'false',
    'priority' => 1
]);

$c->save([
    'task' => '…',
    'inprogress' => 'false',
    'priority' => 4
]);</code></pre>
                    </section>

                    <section data-markdown>
                        ### Atomically [find and modify](http://docs.mongodb.org/manual/reference/command/findAndModify/) a document

<pre><code class="language-php">$db->jobs->findAndModify(
    ['inprogress' => false],
    ['$set' => [
        'inprogress' => true,
        'startedAt' => new MongoDate(),
    ]],
    null,
    [
        'sort' => ['priority' -1],
        'new' => true,
    ]
);</code></pre>

                        * Return document in pre- or post-modified state
                        * Update, upsert, or remove the document
                    </section>
                </section>

                <section>
                    <section data-markdown data-state="indexing">
                        # Indexing
                    </section>

                    <section data-markdown>
                        ## Indexes in MongoDB

                        * B-trees
                        * Multiple indexes per collection
                        * Any field(s), top-level or embedded
                        * [Multikey indexing of array values](http://docs.mongodb.org/manual/core/indexes/#index-type-multikey)
                        * [Sparse](http://docs.mongodb.org/manual/core/indexes/#sparse-indexes), [unique](http://docs.mongodb.org/manual/core/indexes/#unique-indexes), [geospatial](http://docs.mongodb.org/manual/core/indexes/#geospatial-indexes)
                    </section>

                    <section data-markdown>
                        ## Managing Indexes

<pre><code class="language-php">$c = $db->things;

// Ensure unique values for x (just like the _id index)
$c->ensureIndex(['x' => 1], ['unique' => true]);

<span class="fragment">// Don't wait for index creation to succeed
$c->ensureIndex(['x' => 1], ['w' => 0]);</span>

<span class="fragment">// Delegate index creation as a background task
$c->ensureIndex(['x' => 1], ['background' => true]);</span>

<span class="fragment">$c->getIndexInfo(); // Array describing all indexes</span>

<span class="fragment">$c->deleteIndex('x'); // Delete an index by name or field(s)
$c->deleteIndexes();  // Delete all collection indexes</span></code></pre>
                    </section>

                    <section data-markdown>
                        ## Compound Indexes

<pre><code class="language-php">$c->ensureIndex(['x' => 1, 'y' => 1, 'z' => -1]);

// These queries will use the index
$c->find(['x' => 'foo']);
$c->find(['x' => 'foo', 'y' => ['$gt' => 5]]);
$c->find(['x' => 'foo', 'y' => 4])->sort(['z' => -1]);
$c->find(['x' => "foo", 'y' => 8, 'z' => 'baz']);

// This query will not by default
$c->find(['y' => 6]);
</code></pre>

                        * Index multiple fields
                        * Direction per field (range queries, sorting)
                        * Usable for constituent field queries
                    </section>

                    <section data-markdown>
                        ## Explain Your Queries

<pre><code class="language-php">$cursor = $c->find(['x' => 'foo']);
$cursor->explain();
<span class="stdout">array(
  "cursor" => "BtreeCursor x_1", // Avoid BasicCursor
  "isMultiKey" => false,
  "n" => 0,
  "nscannedObjects" => 3,
  "nscanned" => 3,
  "indexOnly" => false,          // Fastest, if possible
  "nYields" => 0,
  "millis" => 0,
  "indexBounds" => array(…),
)</span></code></pre>
                    </section>

                    <section data-markdown>
                        ## Performance Tips

                        * [Keep your indexes and working set in RAM](http://docs.mongodb.org/manual/applications/indexes/#ensure-indexes-fit-ram)
                        * [Mind your read/write ratio](http://docs.mongodb.org/manual/applications/indexes/#consider-performance-when-creating-indexes-for-write-heavy-applications)
                        * [Support multiple queries per index](http://docs.mongodb.org/manual/applications/indexes/#create-indexes-to-support-your-queries)
                        * Avoid non-indexed queries and table scans
                        * [Create indexes that ensure selectivity](http://docs.mongodb.org/manual/applications/indexes/#index-selectivity)
                        * [Indexing advice and FAQ](http://docs.mongodb.org/manual/faq/indexes/)
                    </section>
                </section>

                <section data-markdown data-state="commands">
                    ## Database Commands

                    * Queries to special `$cmd` collection
                    * Shell and driver helpers for some
                    * [MongoDB::command()](http://php.net/manual/en/mongodb.command.php) for the rest
                    * [Reference list](http://docs.mongodb.org/manual/reference/commands/)
                        * Sharding
                        * Replication
                        * Aggregation
                        * Collections
                        * Indexing
                        * Geospatial
                        * Diagnostic
                        * Administration
                </section>

                <section>
                    <section data-markdown>
                        ## Aggregation

                        * [Aggregation framework](http://docs.mongodb.org/manual/aggregation/)
                        * [count()](http://docs.mongodb.org/manual/reference/simple-aggregation/#count), [distinct()](http://docs.mongodb.org/manual/reference/simple-aggregation/#distinct), and [group()](http://docs.mongodb.org/manual/reference/simple-aggregation/#group)
                        * [MapReduce](http://docs.mongodb.org/manual/applications/map-reduce/)
                        * [Hadoop adapter](http://docs.mongodb.org/ecosystem/tools/hadoop/)
                    </section>

                    <section data-markdown data-state="business-requirements">
                        ## Reporting

                        <blockquote>
                            <small>Arbitrary Business Requirement #27533!</small><br>
                            We need a report listing all authors that have written an article for each tag.
                        </blockquote>
                    </section>

                    <section data-markdown>
                        ## Data to Aggregate

<pre><code class="language-php">$c = $db->articles;

$c->save(['author' => 'jen', 'tags' => ['politics', 'tech']]);
$c->save(['author' => 'sue', 'tags' => ['business']]);
$c->save(['author' => 'tom', 'tags' => ['sports']]);
$c->save([
    'author' => 'bob',
    'tags' => ['business', 'sports', 'tech']
]);</code></pre>
                    </section>

                    <section data-markdown>
                        ## MapReduce

<pre><code class="language-php">$map = '
function() {
    for (var i = 0; i &lt; this.tags.length; i++) {
        emit(this.tags[i], { authors: [this.author] });
    }
}';

$reduce = '
function(key, values) {
    var result = { authors: [] };
    values.forEach(function(value) {
        value.authors.forEach(function(author) {
            if (-1 == result.authors.indexOf(author)) {
                result.authors.push(author);
            }
        });
    });
    return result;
}';</code></pre>
                    </section>

                    <section data-markdown>
                        ## MapReduce

<pre><code class="language-php">$rs = $db->command([
    'mapreduce' => 'articles',
    'map' => new MongoCode($map),
    'reduce' => new MongoCode($reduce),
    'out' => ['inline' => true],
]);

<span class="fragment">foreach ($rs['results'] as $r) {
    $authors = implode(', ', $r['value']['authors']);
    printf("%s: %s\n", $r['_id'], $authors);
}
<span class="stdout">business: sue, bob
politics: jen
sports: tom, bob
tech: jen, bob</span></span></code></pre>
                    </section>

                    <section data-markdown>
                        ## Aggregation Framework

<pre><code class="language-php">$rs = $db->articles->aggregate([
    ['$unwind' => '$tags'],
    ['$group' => [
        '_id' => '$tags',
        'authors' => ['$addToSet' => '$author']
    ]],
]);

<span class="fragment">foreach ($rs['result'] as $r) {
    $authors = implode(', ', $r['authors']);
    printf("%s: %s\n", $r['_id'], $authors);
}
<span class="stdout">business: bob, sue
tech: bob, jen
sports: bob, tom
politics: jen</span></span></code></pre>
                    </section>
                </section>

                <section>
                    <section data-markdown data-state="gridfs-title">
                        # GridFS
                    </section>

                    <section data-markdown>
                        ## [GridFS](http://docs.mongodb.org/manual/applications/gridfs/)

                        * File storage within MongoDB
                        * BSON collections
                            * `fs.files`: metadata, custom fields
                            * `fs.chunks`: binary data (1+ per file)
                        * PHP classes
                            * [MongoGridFS](http://php.net/manual/en/class.mongogridfs.php) extends [MongoCollection](http://php.net/manual/en/class.mongocollection.php)
                            * [MongoGridFSFile](http://php.net/manual/en/class.mongogridfsfile.php)
                            * [MongoGridFSCursor](http://php.net/manual/en/class.mongogridfscursor.php) extends [MongoCursor](http://php.net/manual/en/class.mongocursor.php)
                    </section>

                    <section data-markdown>
                        ## MongoGridFS

<pre><code class="language-php">// Default construction (fs.files and fs.chunks)
$grid = $db->getGridFS();
$grid = new MongoGridFS($db);

<span class="fragment">// Custom prefix (images.files and images.chunks)
$grid = $db->getGridFS('images');
$grid = new MongoGridFS($db, 'images');</span>

<span class="fragment">$grid->chunks; // MongoCollection for chunks</span></code></pre>
                    </section>

                    <section data-markdown>
                        ## Storing Files

<pre><code class="language-php">// Store a file and return its _id
$grid->storeFile('photo.jpg', ['extra' => 'metadata']);
$grid->put('photo.jpg', ['extra' => 'metadata']);

<span class="fragment">// Store bytes as a file and return its _id
$grid->storeBytes('foo', ['extra' => 'metadata']);</span>

<span class="fragment">// Store uploads from POST data
$grid->storeUpload('field_name', ['extra' => 'metadata']);</span></code></pre>
                    </section>

                    <section data-markdown>
                        ## Retrieving Files

<pre><code class="language-php">// Get a MongoGridFSFile by its _id
$grid->get(new MongoId('503ce546e84df14d54000000'));

<span class="fragment">// Query for a MongoGridFS file
$grid->findOne(['filename' => 'photo.jpg']);</span>

<span class="fragment">// Query for multiple MongoGridFS files
$yesterday = new MongoDate(strtotime('yesterday'));
$grid->find(['uploadDate' => ['$gt' => $yesterday]]);</span></code></pre>
                    </section>

                    <section data-markdown>
                        ## MongoGridFSFile

<pre><code class="language-php">$file = $grid->findOne(['filename' => 'photo.jpg']);

$file->getFilename(); // Filename string
$file->getLength();   // File size

<span class="fragment">$file->getBytes();    // Get all chunks as a byte string
$file->getResource(); // Stream resource</span>

<span class="fragment">$file->write();               // Write data to stored filename
$file->write('/tmp/foo.jpg'); // Write data to a new file</span>

<span class="fragment">$file->file; // Document from the "files" collection
<span class="stdout">array(
  "_id" => &lt;object of type MongoId&gt;,
  "meta" => "data",
  "filename" => "/data/photo.jpg",
  "uploadDate" => &lt;object of type MongoDate&gt;,
  "length" => 1511769,
  "chunkSize" => 262144,
  "md5" => "40ad6901b991fc8c6e8d2e1578db4db9",
)</span></span></code></pre>
                    </section>

                    <section data-markdown>
                        ## Removing Files

<pre><code class="language-php">// Delete a file (and related chunks) by its _id
$grid->delete(new MongoId('503ce546e84df14d54000000'));

<span class="fragment">// Remove files and their related chunks
$grid->remove(['filename' => 'photo.jpg']);</span>

<span class="fragment">// Drop the files and chunks collections
$grid->drop();</span></code></pre>
                    </section>
                </section>

                <section>
                    <section data-markdown data-state="geospatial-title">
                        # Geospatial Indexing
                    </section>

                    <section data-markdown>
                        ## [Geospatial Indexing](http://docs.mongodb.org/manual/core/geospatial-indexes/)

                        * Geo-hashed, 2D coordinates
                        * Configurable bounds and bit precision
                        * Suggested point format: `[x, y]`
                        * One geospatial index per collection
                        * [Multi-location documents](http://docs.mongodb.org/manual/core/geospatial-indexes/#multi-location-documents)
                        * [Spherical model support](http://docs.mongodb.org/manual/applications/geospatial-indexes/#geospatial-indexes-spherical)
                    </section>

                    <section data-markdown>
                        ## Data to Index

<pre><code class="language-php">$c = $db->places;

$c->save([
    'name' => 'Home',
    'type' => 'residence',
    'loc'  => [0, 0],
]);

$c->save([
    'name' => 'Work',
    'type' => 'office',
    'loc'  => [12, 15],
]);</code></pre>
                    </section>

                    <section data-markdown>
                        ## Bounds Queries

<pre><code class="language-php">$db->places->ensureIndex(['loc' => '2d']);

// Rectangular bounds
$db->places->find(['loc' => ['$within' => ['$box' => [
    [10, 10], // Lower-left
    [20, 20], // Upper-right
]]]]);

<span class="fragment">// Circular bounds
$db->places->find(['loc' => ['$within' => ['$center' => [
    [5, 5], // Center coordinate
    15,     // Radius
]]]]);</span>

<span class="fragment">// Arbitrary polygonal bounds (e.g. triangle)
$db->places->find(['loc' => ['$within' => ['$polygon' => [
    [10, 20],
    [10, 40],
    [30, 40], // Implicitly connected to first point
]]]]);</span></code></pre>
                    </section>

                    <section data-markdown>
                        ## Sorted Proximity Queries

<pre><code class="language-php">// Find locations near a point, ordered by proximity
$db->places->find(['loc' => ['$near' => [50, 50]]]);

<span class="fragment">// Find at most 10 museums within 5 units of a point
$db->places->find([
    'loc' => ['$near' => [50, 50], '$maxDistance' => 5],
    'type' => 'museum',
])->limit(10);</span>

<span class="fragment">// geoNear command includes distance and diagnostic data
$db->command([
    'geoNear' => 'places',
    'near' => [50, 50],
    'maxDistance' => 5,
    'query' => ['type' => 'museum'],
    'num' => 10,
]);</span></code></pre>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        # <span class="mongodb-logo">MongoDB</span>

                        * API caters to you
                        * Features empower you
                        * Scales with you
                    </section>

                    <section data-markdown data-state="companies">
                        # Companies Using MongoDB
                    </section>
                </section>

                <section data-markdown data-state="final">
                    # Thanks!

                    * [Server and drivers](http://www.mongodb.org/downloads)
                    * [PHP documentation](http://php.net/manual/en/book.mongo.php)
                    * [MongoDB documentation](http://docs.mongodb.org/manual/)

                    ### Questions?
                </section>

                <section data-markdown data-state="photo-credits">
                    ### Photo Credits

                    * [http://www.flickr.com/photos/pagedooley/7330663394/](http://www.flickr.com/photos/pagedooley/7330663394/)
                    * [http://www.slxdeveloper.com/page.aspx?action=viewarticle&articleid=92](http://www.slxdeveloper.com/page.aspx?action=viewarticle&articleid=92)
                    * [http://www.sxc.hu/photo/487816](http://www.sxc.hu/photo/487816)
                    * [http://www.flickr.com/photos/sharynmorrow/2224102244/](http://www.flickr.com/photos/sharynmorrow/2224102244/)
                    * [http://www.flickr.com/photos/kwl/6458495675/](http://www.flickr.com/photos/kwl/6458495675/)
                    * [http://www.flickr.com/photos/dierken/7998425310/](http://www.flickr.com/photos/dierken/7998425310/in/)
                    * [http://www.flickr.com/photos/spacebarpark/6712082295/](http://www.flickr.com/photos/spacebarpark/6712082295/)
                    * [http://www.flickr.com/photos/69125796@N00/7415476606/](http://www.flickr.com/photos/69125796@N00/7415476606/)
                    * [http://www.sxc.hu/photo/443042](http://www.sxc.hu/photo/443042)
                    * [http://www.flickr.com/photos/mikebaird/3898801499/](http://www.flickr.com/photos/mikebaird/3898801499/)
                    * [http://history.nasa.gov/ap08fj/photos/a/as08-16-2593hr.jpg](http://history.nasa.gov/ap08fj/photos/a/as08-16-2593hr.jpg)
                </section>
            </div>
        </div>

        <script src="../vendor/reveal.js/lib/js/head.min.js"></script>
        <script src="../vendor/reveal.js/js/reveal.js"></script>
        <script src="../common/js/reveal.js"></script>
        <script src="js/jquery-1.8.0.min.js"></script>
        <script src="js/jquery.jsPlumb-1.3.12-all-min.js"></script>
        <script src="js/main.js"></script>
    </body>
</html>
