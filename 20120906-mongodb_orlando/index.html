<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>MongoDB Aggregation Framework</title>
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <!-- <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'> -->
        <link rel="stylesheet" href="node_modules/reveal.js/css/main.css">
        <link rel="stylesheet" href="node_modules/reveal.js/css/theme/default.css">

        <script>
            // If the query includes 'print-pdf' we'll use the PDF print sheet
            document.write( '<link rel="stylesheet" href="node_modules/reveal.js/css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
        </script>

        <!--<link rel="stylesheet" href="node_modules/reveal.js/lib/css/zenburn.css">-->
        <link rel="stylesheet" href="css/highlight.tomorrow-night.css">
        <link rel="stylesheet" href="css/theme.css">
        <link rel="stylesheet" href="css/main.css">

        <!--[if lt IE 9]>
        <script src="node_modules/reveal.js/lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>
        <div class="reveal">
            <div class="state-background"></div>

            <div class="slides">
                <section data-state="title">
                    <h1><span class="mongodb-logo">MongoDB</span> Aggregation Framework</h1>

                    <span class="new"></span>

                    <p class="bio">Jeremy Mikola<br><a href="http://twitter.com/jmikola">@jmikola</a></p>
                </section>

                <section>
                    <section data-markdown>
                        # MapReduce
                    </section>

                    <section data-markdown>
                        ## MapReduce

                        <img src="img/mapreduce.png" alt="mapreduce.png" style="height: 100%;">
                    </section>

                    <section data-markdown>
                        ## MapReduce

                        * Extremely versatile, powerful
                        * Intended for complex data analysis
                        * Overkill for simple aggregation tasks
                            * Averages
                            * Summation
                            * Grouping
                    </section>

                    <section data-markdown>
                        ## MapReduce in MongoDB

                        * Implemented with JavaScript
                            * Single-threaded
                            * Difficult to debug
                        * Concurrency
                            * Appearance of parallelism
                            * Write locks
                    </section>

                    <section data-markdown>
                        ## Using MapReduce for Aggregation

                        <br>

                        <pre><code class="language-javascript">{ author: "bob", tags: ["business", "sports", "tech"] }</code></pre>
                        <pre><code class="language-javascript">{ author: "jen", tags: ["politics", "tech"] }</code></pre>
                        <pre><code class="language-javascript">{ author: "sue", tags: ["business"] }</code></pre>
                        <pre><code class="language-javascript">{ author: "tom", tags: ["sports"] }</code></pre>

                        <br>
                        Determine the set of authors associated with each tag
                    </section>

                    <section data-markdown>
                        ## Using MapReduce for Aggregation

                        <pre><code class="language-javascript">map = function() {
  for (var i = 0; i &lt; this.tags.length; i++) {
    emit(this.tags[i], { authors: [this.author] });
  }
};

reduce = function(key, values) {
  var result = { authors: [] };
  values.forEach(function(value) {
    value.authors.forEach(function(author) {
      if (-1 == result.authors.indexOf(author)) {
        result.authors.push(author);
      }
    });
  });
  return result;
};

db.articles.mapReduce(map, reduce, { out: { inline: 1 }});</code></pre>
                    </section>

                    <section data-markdown>
                        ## Using MapReduce for Aggregation

                        <pre><code class="language-javascript">{
  results: [
    { _id: "business", value: { authors: ["bob", "sue"] } },
    { _id: "politics", value: { authors: ["jen"] } },
    { _id: "sports",   value: { authors: ["bob", "tom"] } },
    { _id: "tech",     value: { authors: ["bob", "jen"] } }
  ],
  timeMillis: 0,
  counts: {
    input: 4,
    emit: 7,
    reduce: 3,
    output: 4
  },
  ok: 1,
}</code></pre>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        # Aggregation Framework

                        <img src="img/dilbert-20120905.gif" alt="dilbert-20120905.gif">
                    </section>

                    <section data-markdown>
                        ## Aggregation Framework

                        * Declarative (BSON, not JavaScript)
                        * Implemented in C++
                        * Flexible and functional
                            * Operation pipeline
                            * Computational expressions
                        * Plays nice with sharding
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        # Pipeline
                    </section>

                    <section data-markdown data-state="pipeline">
                        ## Pipeline

                        * Process a stream of documents
                            * Original input is a collection
                            * Final output is a result document
                        * Series of operators
                            * Filter or transform data
                            * Input/output chain

                        <pre class="fragment"><code class="no-highlight">ps ax | grep mongod | head -n 1</code></pre>
                    </section>

                    <section data-markdown data-state="pipeline-operators">
                        ## Pipeline Operators

                        * `$match`
                        * `$project`
                        * `$group`
                        * `$unwind`
                        * `$sort`
                        * `$limit`
                        * `$skip`
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## $match

                        * Filter documents
                        * Place early in the pipeline if possible
                        * Uses existing [query syntax](http://docs.mongodb.org/manual/reference/operators/)
                        * No [geospatial operations](http://docs.mongodb.org/manual/reference/operators/#geospatial-query-operators) or `$where`
                    </section>

                    <section data-markdown>
                        ## $match

                        ### Matching Field Values

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{
  title: "The Great Gatsby",
  pages: 218,
  language: "English"
}</code></pre>
                            <pre><code class="language-javascript">{
  title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{
  title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $match: {
  language: "Russian"
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{
  title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                        </div>
                    </section>

                    <section data-markdown>
                        ## $match

                        ### Matching with Query Operators

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{
  title: "The Great Gatsby",
  pages: 218,
  language: "English"
}</code></pre>
                            <pre><code class="language-javascript">{
  title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{
  title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $match: {
  pages: { $gt: 1000 }
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{
  title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{
  title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## $project

                        * Reshape documents
                        * Include, exclude or rename fields
                        * Inject computed fields
                        * Create sub-document fields
                    </section>

                    <section data-markdown>
                        ## $project

                        ### Including and Excluding Fields

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{
  _id: 375,
  title: "The Great Gatsby",
  ISBN: "9781857150193",
  available: true,
  pages: 218,
  subjects: [
    "Long Island",
    "New York",
    "1920s"
  ],
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $project: {
  _id: 0,
  title: 1,
  language: 1
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{
  title: "The Great Gatsby",
  language: "English"
}</code></pre>
                        </div>
                    </section>

                    <section data-markdown>
                        ## $project

                        ### Renaming and Computing Fields

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{
  _id: 375,
  title: "The Great Gatsby",
  ISBN: "9781857150193",
  available: true,
  pages: 218,
  subjects: [
    "Long Island",
    "New York",
    "1920s"
  ],
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $project: {
  upperTitle: {
    $toUpper: "$title"
  },
  lang: "$language"
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{
  _id: 375,
  upperTitle: "THE GREAT GATSBY",
  lang: "English"
}</code></pre>
                        </div>
                    </section>

                    <section data-markdown>
                        ## $project

                        ### Creating Sub-document Fields

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{
  _id: 375,
  title: "The Great Gatsby",
  ISBN: "9781857150193",
  available: true,
  pages: 218,
  subjects: [
    "Long Island",
    "New York",
    "1920s"
  ],
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $project: {
  title: 1,
  stats: {
    pages: "$pages",
    language: "$language",
  }
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{
  _id: 375,
  title: "The Great Gatsby",
  stats: {
    pages: 218,
    language: "English"
  }
}</code></pre>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## $group

                        * Group documents by an ID
                            * Field path reference
                            * Object with multiple references
                            * Constant value
                        * Other output fields are computed
                            * `$max`, `$min`, `$avg`, `$sum`
                            * `$addToSet`, `$push`
                            * `$first`, `$last`
                        * Processes all data in memory
                    </section>

                    <section data-markdown>
                        ## $group

                        ### Calculating an Average

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{
  title: "The Great Gatsby",
  pages: 218,
  language: "English"
}</code></pre>
                            <pre><code class="language-javascript">{
  title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{
  title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $group: {
  _id: "$language",
  avgPages: { $avg: "$pages" }
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{
  _id: "Russian",
  avgPages: 1440
}</code></pre>
                            <pre><code class="language-javascript">{
  _id: "English",
  avgPages: 653
}</code></pre>
                        </div>
                    </section>

                    <section data-markdown>
                        ## $group

                        ### Summating Fields and Counting

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{
  title: "The Great Gatsby",
  pages: 218,
  language: "English"
}</code></pre>
                            <pre><code class="language-javascript">{
  title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{
  title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $group: {
  _id: "$language",
  numTitles: { $sum: 1 },
  sumPages: { $sum: "$pages" }
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{
  _id: "Russian",
  numTitles: 1,
  sumPages: 1440
}</code></pre>
                            <pre><code class="language-javascript">{
  _id: "English",
  numTitles: 2,
  sumPages: 1306
}</code></pre>
                        </div>
                    </section>

                    <section data-markdown>
                        ## $group

                        ### Collecting Distinct Values

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{
  title: "The Great Gatsby",
  pages: 218,
  language: "English"
}</code></pre>
                            <pre><code class="language-javascript">{
  title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{
  title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $group: {
  _id: "$language",
  titles: { $addToSet: "$title" }
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{
  _id: "Russian",
  titles: [ "War and Peace" ]
}</code></pre>
                            <pre><code class="language-javascript">{
  _id: "English",
  titles: [
    "Atlas Shrugged",
    "The Great Gatsby"
  ]
}</code></pre>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## $unwind

                        * Operate on an array field
                        * Yield documents for each array value
                            * Nothing for absent or empty fields
                            * Error for non-array fields
                        * Complements `$group`
                    </section>

                    <section data-markdown>
                        ## $unwind

                        ### Yielding Multiple Documents from One

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{
  title: "The Great Gatsby",
  ISBN: "9781857150193",
  subjects: [
    "Long Island",
    "New York",
    "1920s"
  ]
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $unwind: "$subjects" }</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{
  title: "The Great Gatsby",
  ISBN: "9781857150193",
  subjects: "Long Island"
}</code></pre>
                            <pre><code class="language-javascript">{
  title: "The Great Gatsby",
  ISBN: "9781857150193",
  subjects: "New York"
}</code></pre>
                            <pre><code class="language-javascript">{
  title: "The Great Gatsby",
  ISBN: "9781857150193",
  subjects: "1920s"
}</code></pre>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## $sort

                        * Sort documents by one or more fields
                        * Uses familiar [cursor format](http://docs.mongodb.org/manual/reference/method/cursor.sort/)
                        * Waits for earlier pipeline operator to return
                        * In-memory unless early and indexed
                    </section>

                    <section data-markdown>
                        ## $sort

                        ### Sort All Documents in the Pipeline

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Brave New World" }</code></pre>
                            <pre><code class="language-javascript">{ title: "The Grapes of Wrath" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Animal Farm" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Lord of the Flies" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fathers and Sons" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Invisible Man" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fahrenheit 451" }</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $sort: { title: 1 }}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ title: "Animal Farm" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Brave New World" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fahrenheit 451" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fathers and Sons" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Invisible Man" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Lord of the Flies" }</code></pre>
                            <pre><code class="language-javascript">{ title: "The Grapes of Wrath" }</code></pre>
                            <pre><code class="language-javascript">{ title: "The Great Gatsby" }</code></pre>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## $limit

                        ### Limit Documents through the Pipeline

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Brave New World" }</code></pre>
                            <pre><code class="language-javascript">{ title: "The Grapes of Wrath" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Animal Farm" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Lord of the Flies" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fathers and Sons" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Invisible Man" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fahrenheit 451" }</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $limit: 5 }</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Brave New World" }</code></pre>
                            <pre><code class="language-javascript">{ title: "The Grapes of Wrath" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Animal Farm" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Lord of the Flies" }</code></pre>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## $skip

                        ### Skip Over Documents in the Pipeline

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Brave New World" }</code></pre>
                            <pre><code class="language-javascript">{ title: "The Grapes of Wrath" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Animal Farm" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Lord of the Flies" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fathers and Sons" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Invisible Man" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fahrenheit 451" }</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $skip: 5 }</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ title: "Fathers and Sons" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Invisible Man" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fahrenheit 451" }</code></pre>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## Extending the Framework

                        * Adding new pipeline operators, expressions
                        * `$out` and `$tee` for output control
                            * [https://jira.mongodb.org/browse/SERVER-3253](https://jira.mongodb.org/browse/SERVER-3253)

                    </section>
                </section>

                <section>
                    <section data-markdown>
                        # Expressions
                    </section>

                    <section data-markdown>
                        ## Expressions

                        * Return computed values
                        * Used with `$project` and `$group`
                        * May be nested
                    </section>

                    <section data-markdown>
                        ## Boolean Operators

                        * Input array of one or more values
                            * `$and`, `$or`
                            * Short-circuit logic
                        * Inverse values with `$not`
                        * BSON standard for converting non-booleans
                            * `null`, `undefined`, zero values &rarr; `false`
                            * Non-zero values, strings, dates, objects &rarr; `true`
                    </section>

                    <section data-markdown data-state="comparison-operators">
                        ## Comparison Operators

                        * Compare numbers, strings, and dates
                        * Input array with two operands
                            * `$cmp`, `$eq`, `$ne`
                            * `$gt`, `$gte`, `$lt`, `$lte`
                    </section>

                    <section data-markdown>
                        ## Arithmetic Operators

                        * Input array of one or more numbers
                            * `$add`, `$multiply`
                        * Input array of two operands
                            * `$subtract`, `$divide`, `$mod`
                    </section>

                    <section data-markdown>
                        ## String Operators

                        * `$strcasecmp` case-insensitive comparison
                            * `$cmp` is case-sensitive
                        * `$toLower` and `$toUpper` case change
                        * `$substr` for sub-string extraction
                        * Not encoding aware
                        * Assumes Latin alphabet
                    </section>

                    <section data-markdown>
                        ## Date Operators

                        * Extract values from date objects
                            * `$dayOfYear`, `$dayOfMonth`, `$dayOfWeek`
                            * `$year`, `$month`, `$week`
                            * `$hour`, `$minute`, `$second`
                    </section>

                    <section data-markdown>
                        ## Conditional Operators

                        * `$cond` ternary operator
                        * `$ifNull`
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        # Usage
                    </section>

                    <section data-markdown>
                        ## Usage

                        * `collection.aggregate()` method
                            * Mongo shell
                            * Most drivers
                        * `aggregate` database command
                        * Result limited by BSON document size
                    </section>

                    <section data-markdown>
                        ## Collection Method

                        <pre><code class="language-javascript">db.books.aggregate([
  { $project: { language: 1 }},
  { $group: { _id: "$language", numTitles: { $sum: 1 }}}
])</code></pre>

                        &#x25BC;

                        <pre><code class="language-javascript">{
  result: [
    { _id: "Russian", numTitles: 1 },
    { _id: "English", numTitles: 2 }
  ],
  ok: 1
}</code></pre>
                    </section>

                    <section data-markdown>
                        ## Database Command

                        <pre><code class="language-javascript">db.runCommand({
  aggregate: "books",
  pipeline: [
    { $project: { language: 1 }},
    { $group: { _id: "$language", numTitles: { $sum: 1 }}}
  ]
})</code></pre>

                        &#x25BC;

                        <pre><code class="language-javascript">{
  result: [
    { _id: "Russian", numTitles: 1 },
    { _id: "English", numTitles: 2 }
  ],
  ok: 1
}</code></pre>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        # Optimization
                    </section>

                    <section data-markdown>
                        ## Early Filtering

                        <pre><code class="language-javascript">[
  { $match:   { /* match criteria         */ }},
  { $sort:    { /* sort matched documents */ }},
  { $limit:   { /* limit document stream  */ }},
  { $group:   { /* group by a field       */ }},
  { $sort:    { /* sort by computed value */ }},
  { $project: { /* reshape result         */ }}
]</code></pre>
                    </section>

                    <section data-markdown>
                        ## Early Filtering

                        <pre><code class="language-javascript">db.collection
  .find({ /* match criteria         */ })
  .sort({ /* sort matched documents */ })
  .limit( /* limit document stream  */  )</code></pre>

                        &#x25BC;

                        <pre><code class="language-javascript">[
  { $group:   { /* group by a field       */ }},
  { $sort:    { /* sort by computed value */ }},
  { $project: { /* reshape result         */ }}
]</code></pre>
                    </section>

                    <section data-markdown>
                        ## Memory Usage

                        * `$group` and `$sort` entirely in-memory
                        * Operation memory usage limits
                            * Warning at &gt;5%
                            * Error at &gt;10%
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        # Sharding
                    </section>

                    <section data-markdown>
                        ## Sharding

                        * Split the pipeline at first `$group` or `$sort`
                            * Shards execute pipeline before that point
                            * **mongos** merges results and continues
                        * Early `$match` may excuse shards
                        * CPU and memory implications for **mongos**
                    </section>

                    <section data-markdown>
                        ## Sharding

                        <pre><code class="language-javascript">[
  { $project: { /* select fields     */ }},
  { $sort:    { /* sort by timestamp */ }},
  { $group:   { /* group by minute   */ }},
  { $sort:    { /* sort by timestamp */ }},
  { $project: { /* reshape result    */ }}
]</code></pre>
                    </section>

                    <section data-markdown data-state="sharding-diagram">
                        ## Sharding

                        <div class="node-3">
                            <div>
                                <div class="node">
                                    <span class="label">shard<sub>1</sub></span>
                                    <ul>
                                        <li><code>$project</code></li>
                                        <li><code>$sort</code></li>
                                    </ul>
                                </div>
                                <span class="arrow">&#x2198;</span>
                            </div>
                            <div>
                                <div class="node">
                                    <span class="label">shard<sub>2</sub></span>
                                    <ul>
                                        <li><code>$project</code></li>
                                        <li><code>$sort</code></li>
                                    </ul>
                                </div>
                                <span class="arrow">&#x2193;</span>
                            </div>
                            <div>
                                <div class="node">
                                    <span class="label">shard<sub>3</sub></span>
                                    <ul>
                                        <li><code>$project</code></li>
                                        <li><code>$sort</code></li>
                                    </ul>
                                </div>
                                <span class="arrow">&#x2199;</span>
                            </div>
                        </div>

                        <div class="node-1">
                            <div class="node">
                                <span class="label">mongos</span>
                                <ul>
                                    <li><code>$group</code></li>
                                    <li><code>$sort</code></li>
                                    <li><code>$project</code></li>
                                </ul>
                            </div>
                            <span class="arrow">&#x2193;</span>
                            <div class="node">
                                <span class="label">Result</span>
                            </div>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        # Demo Time

                        ### Plotting the EUR/GDP exchange rate
                    </section>

                    <section data-markdown>
                        ## Input Data

                        <pre><code class="language-javascript">{
  bid: 1.30019,
  ts: ISODate("2012-02-16T12:48:00Z")
}</code></pre>
                        <pre><code class="language-javascript">{
  bid: 1.3002,
  ts: ISODate("2012-02-16T12:48:01Z")
}</code></pre>
                        <pre><code class="language-javascript">{
  bid: 1.30021,
  ts: ISODate("2012-02-16T12:48:02Z")
}</code></pre>
                    </section>

                    <section data-markdown>
                        ## Desired Output

                        <img src="img/candlestick.png" alt="candlestick.png">
                    </section>

                    <section data-markdown>
                        ## Output Format

                        <pre><code class="language-javascript">{
  _id: ISODate("2012-02-16T12:57:00Z"),
  bid: {
    open: 1.29994,
    close: 1.29997,
    high: 1.3001,
    low: 1.29992,
    avg: 1.2999995161290314
  }
}</code></pre>
                    </section>
                </section>

                <section data-markdown data-state="final">
                    # Thanks!

                    * [mongodb.org/downloads](http://www.mongodb.org/downloads)
                    * [docs.mongodb.org/manual/aggregation](http://docs.mongodb.org/manual/aggregation)
                    * [github.com/rozza/demos](https://github.com/rozza/demos)

                    ### Questions?
                </section>

                <section data-markdown data-state="photo-credits">
                    ### Photo Credits

                    * [http://dilbert.com/strips/comic/2012-09-05](http://dilbert.com/strips/comic/2012-09-05)
                </section>
            </div>

            <aside class="controls">
                <a class="left" href="#">&#x25C4;</a>
                <a class="right" href="#">&#x25BA;</a>
                <a class="up" href="#">&#x25B2;</a>
                <a class="down" href="#">&#x25BC;</a>
            </aside>

            <div class="footer"></div>

            <div class="progress"><span></span></div>
        </div>

        <script src="node_modules/reveal.js/lib/js/head.min.js"></script>
        <script src="node_modules/reveal.js/js/reveal.js"></script>
        <script src="js/main.js"></script>
    </body>
</html>
